/* lp/registry/javascript/timeline-min.js */

YUI.add('lp.registry.timeline',function(Y){var module=Y.namespace('lp.registry.timeline');var TIMELINE_GRAPH='timelinegraph';var OBSOLETE_SERIES_STATUS='Obsolete';var getCN=Y.ClassNameManager.getClassName;var C_ZOOM_BOX=getCN(TIMELINE_GRAPH,'zoom-box');var C_ZOOM_IN=getCN(TIMELINE_GRAPH,'zoom-in');var C_ZOOM_OUT=getCN(TIMELINE_GRAPH,'zoom-out');var SECOND_MOUSE_BUTTON=2;var MARGIN_LEFT=20;var MARGIN_TOP=25;var MARGIN_BOTTOM=10;var MILESTONE_RADIUS=5;var RELEASE_RADIUS=5;var ARROW_HEIGHT=10;var ARROW_WIDTH=15;var ANGLE_DEGREES=84;var ANGLE_RADIANS=ANGLE_DEGREES/180*Math.PI;var ANGLE_TANGENT=Math.tan(ANGLE_RADIANS);var FONT_SIZE=1;var LINE_COLOR='darkgreen';var OBSOLETE_SERIES_COLOR='#777777';var MILESTONE_LINE_COLOR='darkgray';var MILESTONE_FILL_COLOR='white';var RELEASE_COLOR='black';var ARROW_COLOR=LINE_COLOR;var ZOOM_JUMPS=1.1;var draw_line=function(canvas_context,points,fill){canvas_context.beginPath();canvas_context.moveTo(points[0].x,points[0].y);Y.each(points.slice(1),function(point,i){canvas_context.lineTo(point.x,point.y);});if(fill===true){canvas_context.fill();}else{canvas_context.stroke();}};var Position=function(x,y){this.x=x;this.y=y;};Position.prototype={copy:function(){return new Position(this.x,this.y);}};var SeriesLine=function(timeline_graph,series,start){this.timeline_graph=timeline_graph;this.series=series;this.start=start;var tooltip=this.series.status+' Series';if(this.series.is_development_focus){tooltip='Development Focus Series';}
this.labels={};Y.each(this.series.landmarks,function(landmark,i){var landmark_tooltip=landmark.type.charAt(0).toUpperCase()+landmark.type.substr(1);if(Y.Lang.isString(landmark.code_name)){landmark_tooltip+=': '+landmark.code_name;}
var cfg={id:landmark.name};if(Y.Lang.isString(this.timeline_graph.resize_frame)){cfg.second_line=landmark.date;}
this.labels[landmark.name]=this.timeline_graph.make_label(landmark.name,landmark_tooltip,landmark.uri,cfg);},this);this.series_date_label=null;if(!Y.Lang.isString(this.timeline_graph.resize_frame)){var i;for(i=0;i<this.series.landmarks.length;i++){var landmark=this.series.landmarks[i];if(landmark.date!==null){this.series_date_label=this.timeline_graph.make_label('','Last date in series',this.series.uri,{second_line:landmark.date,id:series.name+'-'+landmark.date});break;}}}
var label_text=Y.Node.create('<strong/>');label_text.appendChild(document.createTextNode(series.name));this.center_series_label=this.timeline_graph.make_label(label_text,tooltip,this.series.uri,{id:series.name});this.left_series_label=this.timeline_graph.make_label('',tooltip,this.series.uri,{second_line:series.name,id:series.name});this.right_series_label=this.timeline_graph.make_label('',tooltip,this.series.uri,{second_line:series.name,id:series.name});};SeriesLine.prototype={get_length:function(){var length=0;if(this.series.status===OBSOLETE_SERIES_STATUS){length=this.series.landmarks.length*this.timeline_graph.landmark_spacing;}else{length=(this.series.landmarks.length+1)*this.timeline_graph.landmark_spacing;}
return Math.max(length,this.timeline_graph.min_series_line_length);},get_y_spacing:function(){var max_y=0;Y.each(this.series.landmarks,function(landmark,i){var label=this.labels[landmark.name];max_y=Math.max(label.get('offsetHeight'));},this);return max_y+(2*RELEASE_RADIUS)+
this.center_series_label.get('offsetHeight');},draw:function(){var context=this.timeline_graph.canvas_context;var stop=new Position(this.start.x+this.get_length(),this.start.y);var thickness,offset;if(this.series.status===OBSOLETE_SERIES_STATUS){thickness=2;offset=-1;context.fillStyle=OBSOLETE_SERIES_COLOR;}else if(this.series.is_development_focus){thickness=4;offset=-2;context.fillStyle=LINE_COLOR;}else{thickness=1;offset=0;context.fillStyle=LINE_COLOR;}
context.fillRect(this.start.x,this.start.y+offset,stop.x-this.start.x,stop.y-this.start.y+thickness);if(this.series.status!==OBSOLETE_SERIES_STATUS){this.timeline_graph.make_landmark(stop,'arrow');}
var center_position=new Position(this.start.x+(this.get_length()/2),this.start.y-RELEASE_RADIUS);this.timeline_graph.place_label(center_position,this.center_series_label,'center','above');var line_width=this.get_length()*this.timeline_graph.graph_scale;if(line_width<Y.DOM.winWidth()){this.left_series_label.setStyle('display','none');this.right_series_label.setStyle('display','none');}else{this.left_series_label.setStyle('display','block');this.right_series_label.setStyle('display','block');var left_position=new Position(this.start.x+10,this.start.y-RELEASE_RADIUS);this.timeline_graph.place_label(left_position,this.left_series_label,'right','above');var right_position=new Position(this.start.x+this.get_length(),this.start.y-RELEASE_RADIUS);this.timeline_graph.place_label(right_position,this.right_series_label,'left','above');}
if(this.series_date_label!==null){var label_position=new Position(stop.x+(ARROW_WIDTH/2),this.start.y);this.timeline_graph.place_label(label_position,this.series_date_label,'right','middle');}
Y.each(this.series.landmarks,function(landmark,i){var position_index=this.series.landmarks.length-i;var landmark_position=new Position(this.start.x+
(position_index*this.timeline_graph.landmark_spacing),this.start.y);this.timeline_graph.make_landmark(landmark_position,landmark.type);var landmark_label_position=new Position(landmark_position.x,landmark_position.y+RELEASE_RADIUS);this.timeline_graph.place_label(landmark_label_position,this.labels[landmark.name],'center','below');},this);}};var ProjectLine=function(timeline_graph,timeline){if(timeline.length===0){throw new Error("The timeline array is empty.");}
this.timeline_graph=timeline_graph;this.timeline=timeline;this.series_lines=[];this.initSeries();this.start=this.series_lines[0].start.copy();var last_series=this.series_lines[this.series_lines.length-1];this.stop=last_series.start.copy();};ProjectLine.prototype={initSeries:function(){var current=new Position(0,MARGIN_TOP);var reversed_timeline=this.timeline.slice().reverse();Y.each(reversed_timeline,function(series,i){var series_line=new SeriesLine(this.timeline_graph,series,current.copy());this.series_lines.push(series_line);var height=series_line.get_y_spacing();current.x-=height/ANGLE_TANGENT;current.y+=height;},this);if(current.x<MARGIN_LEFT){var shift_x=-current.x+MARGIN_LEFT;Y.each(this.series_lines,function(series_line,i){series_line.start.x+=shift_x;},this);}},get_width:function(){var max_x=0;Y.each(this.series_lines,function(series_line,i){var landmarks=series_line.series.landmarks;var text_beyond_last_landmark;if(landmarks.length===0){text_beyond_last_landmark=0;}else{var landmark=landmarks[landmarks.length-1];var label=this.series_lines[i].labels[landmark.name];text_beyond_last_landmark=label.get('offsetWidth')/2;}
var series_width=this.series_lines[i].start.x+
this.series_lines[i].get_length()+
text_beyond_last_landmark;max_x=Math.max(max_x,series_width);},this);return max_x;},get_height:function(){var bottom_label_height=0;var last_series=this.series_lines[this.series_lines.length-1];var key;for(key in last_series.labels){if(last_series.labels.hasOwnProperty(key)){var label=last_series.labels[key];bottom_label_height=Math.max(bottom_label_height,label.get('offsetHeight'));}}
return this.stop.y+bottom_label_height+RELEASE_RADIUS;},draw:function(){var context=this.timeline_graph.canvas_context;context.strokeStyle=LINE_COLOR;draw_line(context,[this.start,this.stop]);Y.each(this.series_lines,function(series_line,i){series_line.draw();},this);}};module.isCanvasSupported=function(){var elem=document.createElement('canvas');return!!(elem.getContext&&elem.getContext('2d'));};module.TimelineGraph=function(){module.TimelineGraph.superclass.constructor.apply(this,arguments);};module.TimelineGraph.NAME=TIMELINE_GRAPH;module.TimelineGraph.ATTRS={timeline:{value:[]}};Y.extend(module.TimelineGraph,Y.Widget,{initializer:function(cfg){if(cfg===undefined||cfg.timeline===undefined){throw new Error("Missing timeline config argument for TimelineGraph.");}
if(cfg!==undefined&&cfg.resize_frame!==undefined){if(!Y.Lang.isString(cfg.resize_frame)){throw new Error("resize_frame config argument must be a string.");}
if(Y.Lang.trim(cfg.resize_frame)===''){throw new Error("resize_frame must not be empty.");}
this.resize_frame=cfg.resize_frame;}
this.graph_scale=1;},zoom_in:function(){this.graph_scale*=ZOOM_JUMPS;this.syncUI();},zoom_out:function(){this.graph_scale/=ZOOM_JUMPS;this.syncUI();},recreate_canvas:function(){var width=Math.ceil(this.graph_scale*(this.project_line.get_width()+MARGIN_LEFT));var height=Math.ceil((this.graph_scale*this.project_line.get_height())+
MARGIN_BOTTOM);if(this.canvas){this.get('contentBox').removeChild(this.canvas);}
this.canvas=Y.Node.create('<canvas width="'+width+'" height="'+height+'"/>');this.get('contentBox').insertBefore(this.canvas,this.get('contentBox').get('children').item(0));if(Y.Lang.isString(this.resize_frame)){var frame=parent.document.getElementById(this.resize_frame);if(frame===null){Y.log('Frame not found: '+this.resize_frame);}
else{frame.height=height;}}},calculate_landmark_spacing:function(){var max_label_width=0;var series_max_label_width=0;Y.each(this.project_line.series_lines,function(series_line,i){series_max_label_width=Math.max(series_max_label_width,series_line.center_series_label.get('offsetWidth'));Y.each(series_line.labels,function(label,j){this.set_font_size(label);max_label_width=Math.max(max_label_width,label.get('offsetWidth'));},this);},this);this.landmark_spacing=max_label_width+5;this.min_series_line_length=series_max_label_width+5;},set_font_size:function(label){label.setStyle('fontSize',(FONT_SIZE*this.graph_scale)+'em');},scroll_to_last_development_focus_landmark:function(label){var series_line=this.project_line.series_lines[0];var landmark=series_line.series.landmarks[0];if(landmark){var date_label_width=0;if(series_line.series_date_label!==null){date_label_width=series_line.series_date_label.get('offsetWidth');}
var scroll_x=series_line.start.x+series_line.get_length()+
ARROW_WIDTH+date_label_width-
Y.DOM.winWidth();scroll_x-=window.scrollX;window.scrollBy(scroll_x,0);}},renderUI:function(){this.zoom_in_button=Y.Node.create('<a class="bg-image"  '+'   style="background-image: url(/@@/zoom-in);'+'          height: 14px">&nbsp;</a>');this.zoom_in_button.addClass(C_ZOOM_IN);this.zoom_out_button=Y.Node.create('<a class="bg-image" '+'   style="background-image: url(/@@/zoom-out);'+'          height: 14px"></a>');this.zoom_out_button.addClass(C_ZOOM_OUT);var zoom_box=Y.Node.create('<div style="'+'background-color: white; position: fixed; '+'top: 0px; left: 0px; padding-left: 2px; '+'cursor: pointer; z-index: 100"/>');zoom_box.addClass(C_ZOOM_BOX);zoom_box.appendChild(this.zoom_in_button);zoom_box.appendChild(this.zoom_out_button);var contentBox=this.get('contentBox');contentBox.appendChild(zoom_box);this.project_line=new ProjectLine(this,this.get('timeline'));},bindUI:function(){this.zoom_in_button.on('click',function(){this.zoom_in();},this);this.zoom_out_button.on('click',function(){this.zoom_out();},this);},syncUI:function(){this.calculate_landmark_spacing();this.recreate_canvas();var dom_canvas=Y.Node.getDOMNode(this.canvas);this.canvas_context=dom_canvas.getContext('2d');this.canvas_context.scale(this.graph_scale,this.graph_scale);this.project_line.draw();},make_label:function(text,tooltip,uri,cfg){if(cfg===undefined){cfg={};}
var label=Y.Node.create('<div style="white-space: nowrap; text-align: center"/>');if(Y.Lang.isString(cfg.id)){label.set('id',cfg.id);}
var text_node;if(text instanceof Y.Node||text instanceof Text){text_node=text;}else{text_node=document.createTextNode(text);}
if(uri){var link=Y.Node.create('<a/>');link.appendChild(text_node);link.on('click',function(e){if(e.which!==SECOND_MOUSE_BUTTON){parent.location.href=uri;e.preventDefault();}});link.set('href',uri);label.appendChild(link);}else{var span=Y.Node.create('<span/>');span.appendChild(text_node);label.appendChild(span);}
label.setStyle('position','absolute');if(tooltip){label.set('title',tooltip);}
if(Y.Lang.isString(cfg.second_line)){var div=Y.Node.create('<div style="color: #aaaaaa; font-size: 70%"/>');div.appendChild(document.createTextNode(cfg.second_line));label.appendChild(div);}
this.get('contentBox').appendChild(label);return label;},place_label:function(position,label,x_align,y_align){var graph_scale=this.graph_scale;var dom_canvas=Y.Node.getDOMNode(this.canvas);this.set_font_size(label);var label_height=label.get('offsetHeight');var y_align_offset;if(y_align==='above'){y_align_offset=-label_height;}else if(y_align==='below'){y_align_offset=0;}else if(y_align==='middle'){y_align_offset=-(label_height/2);}else{throw"Invalid y_align argument: "+y_align;}
var x_align_offset;if(x_align==='left'){x_align_offset=-label.get('offsetWidth');}else if(x_align==='center'){x_align_offset=-(label.get('offsetWidth')/2);}else if(x_align==='right'){x_align_offset=0;}else{throw"Invalid x_align argument: "+x_align;}
var scaled_position=new Position(position.x*graph_scale+
dom_canvas.offsetLeft+x_align_offset,position.y*graph_scale+
dom_canvas.offsetTop+y_align_offset);label.setStyle('left',scaled_position.x+"px");label.setStyle('top',scaled_position.y+"px");},make_landmark:function(position,type){var context=this.canvas_context;if(type==='milestone'){context.fillStyle=MILESTONE_LINE_COLOR;context.beginPath();context.arc(position.x,position.y,MILESTONE_RADIUS,0,(Math.PI*2),true);context.fill();context.fillStyle=MILESTONE_FILL_COLOR;context.beginPath();context.arc(position.x,position.y,MILESTONE_RADIUS-2,0,(Math.PI*2),true);context.fill();}else if(type==='release'){context.fillStyle=RELEASE_COLOR;context.beginPath();context.arc(position.x,position.y,RELEASE_RADIUS,0,(Math.PI*2),true);context.fill();}else if(type==='arrow'){context.fillStyle=ARROW_COLOR;var point=position.copy();point.x+=3;var path=[point];point=point.copy();point.x-=ARROW_WIDTH/2;point.y-=ARROW_HEIGHT/2;path.push(point);point=point.copy();point.x+=ARROW_WIDTH/4;point.y+=ARROW_HEIGHT/2;path.push(point);point=point.copy();point.x-=ARROW_WIDTH/4;point.y+=ARROW_HEIGHT/2;path.push(point);draw_line(context,path,true);}
else{throw"Unknown landmark type: "+type;}}});},"0.1",{"requires":["oop","node","widget"]});
